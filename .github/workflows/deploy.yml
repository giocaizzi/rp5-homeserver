name: Deploy Services

on:
  push:
    branches: [ main ]
    paths: [ 'services/**' ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changed services
        id: changes
        run: |
          changed_files=$(git diff --name-only HEAD^ HEAD)
          services=$(echo "$changed_files" | grep '^services/' | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "services=$services" >> $GITHUB_OUTPUT
          echo "Changed services: $services"

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
    steps:
      - name: Deploy ${{ matrix.service }}
        env:
          WEBHOOK_IDS: |
            {
              "n8n": "${{ secrets.WEBHOOK_ID_N8N }}",
              "firefly": "${{ secrets.WEBHOOK_ID_FIREFLY }}",
              "adguard": "${{ secrets.WEBHOOK_ID_ADGUARD }}"
            }
        run: |
          webhook_id=$(echo '${{ env.WEBHOOK_IDS }}' | jq -r '.["${{ matrix.service }}"]')
          if [ "$webhook_id" != "null" ] && [ "$webhook_id" != "" ]; then
            echo "Deploying ${{ matrix.service }} with webhook ID: $webhook_id"
            response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
              -H "CF-Access-Client-Id: ${{ secrets.CF_ACCESS_CLIENT_ID }}" \
              -H "CF-Access-Client-Secret: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}" \
              "${{ secrets.PORTAINER_URL }}/api/stacks/webhooks/${webhook_id}")
            
            http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
            
            if [ "$http_code" = "204" ]; then
              echo "✅ Successfully triggered deployment for ${{ matrix.service }}"
            else
              echo "❌ Failed to deploy ${{ matrix.service }}. HTTP code: $http_code"
              echo "Response: $response"
              exit 1
            fi
          else
            echo "⚠️  No webhook configured for ${{ matrix.service }} - skipping deployment"
          fi