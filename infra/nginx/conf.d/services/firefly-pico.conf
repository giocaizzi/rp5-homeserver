# Firefly Pico - Mobile companion (Nuxt.js SSR)
server {
    listen 443 ssl;
    http2 on;
    server_name firefly-pico.home;

    include snippets/ssl-params.conf;
    include snippets/error-503.conf;

    # Rate limiting for login endpoints
    location ~* ^/(login|auth) {
        limit_req zone=login burst=5 nodelay;
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
    }

    # Nuxt.js assets directory (_nuxt/) - critical for dynamic imports
    location ~* ^/_nuxt/.*\.(js|css|map)$ {
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
        
        # Increase timeouts for slow Pi SSR generation
        proxy_connect_timeout 10s;
        proxy_send_timeout 15s;
        proxy_read_timeout 15s;
        
        # Disable buffering for faster delivery
        proxy_buffering off;
        proxy_cache off;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        
        # No client-side caching for JS to prevent stale modules
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # Nuxt.js fonts and images from _nuxt can be cached
    location ~* ^/_nuxt/.*\.(woff|woff2|ttf|eot|ico|png|jpg|jpeg|gif|svg)$ {
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
        include snippets/static-assets.conf;
    }

    # API routes
    location ~* ^/(api|_) {
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
    }

    # Static assets with higher rate limit
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
        include snippets/static-assets.conf;
    }

    location / {
        limit_req zone=general burst=20 nodelay;
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
        
        # Increased timeouts for Nuxt SSR on Pi
        proxy_connect_timeout 15s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Disable buffering for SSR responses
        proxy_buffering off;
        
        # SPA support - handle client-side routing
        try_files $uri $uri/ @fallback;
    }
    
    # Fallback for SPA routing
    location @fallback {
        set $upstream $backend;
        proxy_pass http://$upstream;
        include snippets/proxy-headers.conf;
    }
}
