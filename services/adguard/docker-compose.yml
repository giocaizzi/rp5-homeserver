networks:
  # Private network for adguard stack
  adguard_network:
    driver: overlay
    name: rp5_adguard
  
  # External network to connect to nginx proxy
  public_network:
    external: true
    name: rp5_public

services:
  adguard:
    image: adguard/adguardhome:latest
    hostname: adguard
    ports:
      # DNS ports (host network mode for DNS)
      - "53:53/tcp"
      - "53:53/udp"
      # DNS-over-TLS
      - "853:853/tcp"
      # DNS-over-QUIC
      - "853:853/udp"
      # DNSCrypt
      - "5443:5443/tcp"
      - "5443:5443/udp"
    expose:
      # Web interface (proxied via nginx)
      - "3000"
    environment:
      - TZ=Europe/Rome
      - AGH_CONFIG_PATH=/opt/adguardhome/conf/AdGuardHome.yaml
      - AGH_WORK_DIR=/opt/adguardhome/work
    volumes:
      - adguard_work:/opt/adguardhome/work
      - adguard_conf:/opt/adguardhome/conf
    networks:
      - adguard_network
      - public_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "stack=adguard"
    security_opt:
      - no-new-privileges:true
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  adguard_work:
    driver: local
  adguard_conf:
    driver: local