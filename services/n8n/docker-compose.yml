version: "3.8"

networks:
  # Private network for n8n stack
  n8n_network:
    driver: bridge
    name: rp5_n8n
    internal: false  # Allow external access via nginx proxy

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    env_file:
      - .env
    # Remove direct port exposure - access via nginx proxy
    expose:
      - "5678"
    environment:
      # Network configuration
      N8N_HOST: "n8n.local"
      N8N_PORT: 5678
      N8N_PROTOCOL: "https"  # Changed to https since nginx handles SSL
      N8N_LISTEN_ADDRESS: "0.0.0.0"
      
      # Timezone
      GENERIC_TIMEZONE: "${TZ:-UTC}"
      TZ: "${TZ:-UTC}"
      
      # Database configuration
      DB_TYPE: "sqlite"
      DB_SQLITE_DATABASE: "/data/n8n.sqlite"
      DB_SQLITE_VACUUM_ON_STARTUP: "true"
      
      # Security configuration
      N8N_SECURE_COOKIE: "true"  # Enable secure cookies with HTTPS
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: "admin"
      N8N_BASIC_AUTH_PASSWORD: "${N8N_BASIC_AUTH_PASSWORD}"
      
      # Performance and features
      N8N_LOG_LEVEL: "info"
      N8N_LOG_OUTPUT: "console"
      EXECUTIONS_PROCESS: "main"
      EXECUTIONS_DATA_PRUNE: "true"
      EXECUTIONS_DATA_MAX_AGE: 168  # 7 days in hours
      
      # Webhook configuration for reverse proxy
      WEBHOOK_URL: "https://n8n.local"
      
      # Security headers
      N8N_ADDITIONAL_ALLOWED_ORIGINS: "https://n8n.local"
      
    volumes:
      - ${N8N_DATA_PATH:-./data/n8n}:/data
      - ${N8N_LOGS_PATH:-./logs/n8n}:/var/log/n8n
    networks:
      - n8n_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "service=n8n"
      - "type=automation"
      - "stack=n8n"
    security_opt:
      - no-new-privileges:true
    user: "${PUID:-1000}:${PGID:-1000}"  # Run as non-root user
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.5"
    tmpfs:
      - /tmp
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
