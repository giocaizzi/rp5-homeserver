# Langfuse - LLM Observability and Tracing Platform
# Deployed via Portainer using remote repository feature
# https://langfuse.com/docs/deployment/self-host

# =============================================================================
# YAML Anchors - Common configurations
# =============================================================================
x-labels-base: &labels-base
  com.giocaizzi.namespace: "langfuse"
  com.giocaizzi.env: "production"

x-deploy-base: &deploy-base
  mode: replicated
  replicas: 1
  placement:
    constraints:
      - node.role == manager
  restart_policy:
    condition: any
    delay: 5s
    max_attempts: 3
    window: 120s

x-logging-base: &logging-base
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-security-base: &security-base
  security_opt:
    - no-new-privileges:true

# Shared Langfuse environment variables (non-secret)
x-langfuse-env: &langfuse-env
  # Database (password injected via entrypoint)
  DATABASE_HOST: "langfuse-db"
  DATABASE_PORT: "5432"
  DATABASE_NAME: "langfuse"
  DATABASE_USERNAME: "langfuse"
  # ClickHouse
  CLICKHOUSE_MIGRATION_URL: "clickhouse://langfuse-analytics:9000"
  CLICKHOUSE_URL: "http://langfuse-analytics:8123"
  CLICKHOUSE_USER: "clickhouse"
  CLICKHOUSE_CLUSTER_ENABLED: "false"
  # S3 (MinIO) - credentials injected via entrypoint
  LANGFUSE_S3_EVENT_UPLOAD_BUCKET: "langfuse"
  LANGFUSE_S3_EVENT_UPLOAD_REGION: "auto"
  LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: "http://langfuse-storage:9000"
  LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: "true"
  LANGFUSE_S3_EVENT_UPLOAD_PREFIX: "events/"
  LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: "langfuse"
  LANGFUSE_S3_MEDIA_UPLOAD_REGION: "auto"
  LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: "http://langfuse-storage:9000"
  LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"
  LANGFUSE_S3_MEDIA_UPLOAD_PREFIX: "media/"
  LANGFUSE_S3_BATCH_EXPORT_ENABLED: "false"
  # Redis (password injected via entrypoint)
  REDIS_HOST: "langfuse-cache"
  REDIS_PORT: "6379"
  REDIS_TLS_ENABLED: "false"
  # General
  TELEMETRY_ENABLED: "false"
  LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES: "true"

# =============================================================================
# Networks
# =============================================================================
networks:
  # Private network for langfuse stack
  langfuse_network:
    driver: overlay
    name: rp5_langfuse

  # External network to connect to nginx proxy
  public_network:
    external: true
    name: rp5_public

  # External network for observability (Alloy scraping)
  observability_network:
    external: true
    name: rp5_observability

# =============================================================================
# Volumes
# =============================================================================
volumes:
  langfuse_db:
    driver: local
  minio_data:
    driver: local
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local

# =============================================================================
# Configs (inline - deployed with stack)
# =============================================================================
configs:
  clickhouse_config:
    file: ./clickhouse/config.xml
  clickhouse_users:
    file: ./clickhouse/users.xml
  postgres_config:
    file: ./postgres/postgresql.conf
  redis_config:
    file: ./redis/redis.conf

# =============================================================================
# Secrets (external - create on Pi before deployment)
# =============================================================================
secrets:
  # Langfuse app secrets
  langfuse_salt:
    external: true
    name: langfuse_salt
  langfuse_encryption_key:
    external: true
    name: langfuse_encryption_key
  langfuse_nextauth_secret:
    external: true
    name: langfuse_nextauth_secret
  langfuse_admin_password:
    external: true
    name: langfuse_admin_password
  langfuse_public_key:
    external: true
    name: langfuse_public_key
  langfuse_secret_key:
    external: true
    name: langfuse_secret_key
  # Internal service secrets
  langfuse_postgres_password:
    external: true
    name: langfuse_postgres_password
  langfuse_clickhouse_password:
    external: true
    name: langfuse_clickhouse_password
  langfuse_minio_password:
    external: true
    name: langfuse_minio_password
  langfuse_redis_password:
    external: true
    name: langfuse_redis_password

# =============================================================================
# Services
# =============================================================================
services:
  # ========================================
  # MinIO - S3-compatible object storage
  # ========================================
  storage:
    image: minio/minio:latest
    hostname: langfuse-storage
    entrypoint: sh
    command: -c 'mkdir -p /data/langfuse && export MINIO_ROOT_PASSWORD=$$(cat /run/secrets/langfuse_minio_password) && minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: "minio"
    secrets:
      - langfuse_minio_password
    expose:
      - "9000"  # S3 API
      - "9001"  # Console
    volumes:
      - minio_data:/data
    networks:
      - langfuse_network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "storage"
      com.giocaizzi.component: "data"
      com.giocaizzi.tier: "core"
      com.giocaizzi.technology: "minio"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 256M
    logging:
      <<: *logging-base

  # ========================================
  # ClickHouse - OLAP database
  # ========================================
  analytics:
    image: clickhouse/clickhouse-server:latest
    hostname: langfuse-analytics
    user: "101:101"
    environment:
      CLICKHOUSE_DB: "default"
      CLICKHOUSE_USER: "clickhouse"
    secrets:
      - langfuse_clickhouse_password
    entrypoint:
      - /bin/bash
      - -c
      - |
        export CLICKHOUSE_PASSWORD="$$(cat /run/secrets/langfuse_clickhouse_password)"
        exec env CLICKHOUSE_PASSWORD="$$CLICKHOUSE_PASSWORD" /entrypoint.sh
    expose:
      - "8123"  # HTTP interface
      - "9000"  # Native protocol
      - "9363"  # Prometheus metrics
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    configs:
      - source: clickhouse_config
        target: /etc/clickhouse-server/config.d/custom.xml
        mode: 0444
      - source: clickhouse_users
        target: /etc/clickhouse-server/users.d/custom.xml
        mode: 0444
    networks:
      - langfuse_network
      - observability_network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "analytics"
      com.giocaizzi.component: "data"
      com.giocaizzi.tier: "core"
      com.giocaizzi.technology: "clickhouse"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 1024M
    logging:
      <<: *logging-base

  # ========================================
  # PostgreSQL - Primary database
  # ========================================
  db:
    image: postgres:16-alpine
    hostname: langfuse-db
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    environment:
      POSTGRES_DB: "langfuse"
      POSTGRES_USER: "langfuse"
      POSTGRES_PASSWORD_FILE: "/run/secrets/langfuse_postgres_password"
      TZ: "Europe/Rome"
      PGTZ: "Europe/Rome"
    secrets:
      - langfuse_postgres_password
    expose:
      - "5432"
    volumes:
      - langfuse_db:/var/lib/postgresql/data
    configs:
      - source: postgres_config
        target: /etc/postgresql/postgresql.conf
        mode: 0444
    networks:
      - langfuse_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse -d langfuse"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "db"
      com.giocaizzi.component: "data"
      com.giocaizzi.tier: "core"
      com.giocaizzi.technology: "postgres"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 256M
    logging:
      <<: *logging-base

  # ========================================
  # Redis - Cache and queues
  # ========================================
  cache:
    image: redis:7-alpine
    hostname: langfuse-cache
    entrypoint:
      - /bin/sh
      - -c
      - |
        REDIS_PASS=$$(cat /run/secrets/langfuse_redis_password)
        sed "s/REDIS_PASSWORD_PLACEHOLDER/$$REDIS_PASS/" /etc/redis/redis.conf.template > /tmp/redis.conf
        exec redis-server /tmp/redis.conf
    expose:
      - "6379"
    secrets:
      - langfuse_redis_password
    configs:
      - source: redis_config
        target: /etc/redis/redis.conf.template
        mode: 0444
    networks:
      - langfuse_network
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $$(cat /run/secrets/langfuse_redis_password) ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "cache"
      com.giocaizzi.component: "data"
      com.giocaizzi.tier: "core"
      com.giocaizzi.technology: "redis"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 128M
    logging:
      <<: *logging-base

  # ========================================
  # Redis Exporter - Metrics for Prometheus/Alloy
  # ========================================
  cache-exporter:
    image: oliver006/redis_exporter:alpine
    hostname: langfuse-cache-exporter
    expose:
      - "9121"
    environment:
      - REDIS_ADDR=redis://langfuse-cache:6379
    secrets:
      - langfuse_redis_password
    entrypoint:
      - /bin/sh
      - -c
      - |
        export REDIS_PASSWORD=$$(cat /run/secrets/langfuse_redis_password)
        exec /redis_exporter
    networks:
      - langfuse_network
      - observability_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9121/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "cache-exporter"
      com.giocaizzi.component: "worker"
      com.giocaizzi.tier: "extra"
      com.giocaizzi.technology: "redis-exporter"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 64M
    logging:
      <<: *logging-base

  # ========================================
  # PostgreSQL Exporter - Metrics for Prometheus/Alloy
  # ========================================
  db-exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:latest
    hostname: langfuse-db-exporter
    expose:
      - "9187"
    environment:
      - DATA_SOURCE_URI=langfuse-db:5432/langfuse?sslmode=disable
      - DATA_SOURCE_USER=langfuse
    secrets:
      - langfuse_postgres_password
    entrypoint:
      - /bin/sh
      - -c
      - |
        export DATA_SOURCE_PASS=$$(cat /run/secrets/langfuse_postgres_password)
        exec /bin/postgres_exporter
    networks:
      - langfuse_network
      - observability_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9187/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "db-exporter"
      com.giocaizzi.component: "worker"
      com.giocaizzi.tier: "extra"
      com.giocaizzi.technology: "postgres-exporter"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 64M
    logging:
      <<: *logging-base

  # ========================================
  # Langfuse Worker - Async event processing
  # ========================================
  worker:
    image: langfuse/langfuse-worker:latest
    hostname: langfuse-worker
    environment:
      <<: *langfuse-env
      NEXTAUTH_URL: "https://langfuse.home"
    secrets:
      - langfuse_salt
      - langfuse_encryption_key
      - langfuse_postgres_password
      - langfuse_clickhouse_password
      - langfuse_minio_password
      - langfuse_redis_password
    entrypoint:
      - /bin/sh
      - -c
      - |
        export SALT=$$(cat /run/secrets/langfuse_salt)
        export ENCRYPTION_KEY=$$(cat /run/secrets/langfuse_encryption_key)
        export DATABASE_URL="postgresql://langfuse:$$(cat /run/secrets/langfuse_postgres_password)@langfuse-db:5432/langfuse"
        export CLICKHOUSE_PASSWORD=$$(cat /run/secrets/langfuse_clickhouse_password)
        export LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID="minio"
        export LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=$$(cat /run/secrets/langfuse_minio_password)
        export LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID="minio"
        export LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY=$$(cat /run/secrets/langfuse_minio_password)
        export REDIS_AUTH=$$(cat /run/secrets/langfuse_redis_password)
        exec dumb-init -- ./worker/entrypoint.sh node worker/dist/index.js
    expose:
      - "3030"
    networks:
      - langfuse_network
    labels:
      <<: *labels-base
      com.giocaizzi.service: "worker"
      com.giocaizzi.component: "worker"
      com.giocaizzi.tier: "core"
      com.giocaizzi.technology: "langfuse"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 512M
    logging:
      <<: *logging-base

  # ========================================
  # Langfuse Web - Main application
  # ========================================
  app:
    image: langfuse/langfuse:latest
    hostname: langfuse-app
    environment:
      <<: *langfuse-env
      NEXTAUTH_URL: "https://langfuse.home"
      HOSTNAME: "0.0.0.0"
      PORT: "3000"
      # Init configuration
      LANGFUSE_INIT_ORG_ID: "default"
      LANGFUSE_INIT_ORG_NAME: "Home Server"
      LANGFUSE_INIT_PROJECT_ID: "default"
      LANGFUSE_INIT_PROJECT_NAME: "Default Project"
      LANGFUSE_INIT_USER_EMAIL: "admin@langfuse.local"
      LANGFUSE_INIT_USER_NAME: "Admin"
    secrets:
      - langfuse_salt
      - langfuse_encryption_key
      - langfuse_nextauth_secret
      - langfuse_admin_password
      - langfuse_public_key
      - langfuse_secret_key
      - langfuse_postgres_password
      - langfuse_clickhouse_password
      - langfuse_minio_password
      - langfuse_redis_password
    entrypoint:
      - /bin/sh
      - -c
      - |
        export SALT=$$(cat /run/secrets/langfuse_salt)
        export ENCRYPTION_KEY=$$(cat /run/secrets/langfuse_encryption_key)
        export NEXTAUTH_SECRET=$$(cat /run/secrets/langfuse_nextauth_secret)
        export LANGFUSE_INIT_USER_PASSWORD=$$(cat /run/secrets/langfuse_admin_password)
        export LANGFUSE_INIT_PROJECT_PUBLIC_KEY=$$(cat /run/secrets/langfuse_public_key)
        export LANGFUSE_INIT_PROJECT_SECRET_KEY=$$(cat /run/secrets/langfuse_secret_key)
        export DATABASE_URL="postgresql://langfuse:$$(cat /run/secrets/langfuse_postgres_password)@langfuse-db:5432/langfuse"
        export CLICKHOUSE_PASSWORD=$$(cat /run/secrets/langfuse_clickhouse_password)
        export LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID="minio"
        export LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY=$$(cat /run/secrets/langfuse_minio_password)
        export LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID="minio"
        export LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY=$$(cat /run/secrets/langfuse_minio_password)
        export REDIS_AUTH=$$(cat /run/secrets/langfuse_redis_password)
        exec dumb-init -- ./web/entrypoint.sh node ./web/server.js --keepAliveTimeout 110000
    expose:
      - "3000"
    networks:
      - langfuse_network
      - public_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/api/public/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "app"
      com.giocaizzi.component: "app"
      com.giocaizzi.tier: "core"
      com.giocaizzi.technology: "langfuse"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 512M
    logging:
      <<: *logging-base
