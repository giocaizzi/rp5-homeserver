# =============================================================================
# YAML Anchors - Common configurations
# =============================================================================
x-labels-base: &labels-base
  com.giocaizzi.namespace: "firefly"
  com.giocaizzi.env: "production"

x-deploy-base: &deploy-base
  mode: replicated
  replicas: 1
  placement:
    constraints:
      - node.role == manager
  restart_policy:
    condition: any
    delay: 5s
    max_attempts: 3
    window: 120s

x-logging-base: &logging-base
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-security-base: &security-base
  security_opt:
    - no-new-privileges:true

# =============================================================================
# Networks
# =============================================================================
networks:
  # Private network for firefly stack
  firefly_network:
    driver: overlay
    name: rp5_firefly
  
  # External network to connect to nginx proxy
  public_network:
    external: true
    name: rp5_public

# =============================================================================
# Services
# =============================================================================
services:
  firefly:
    image: fireflyiii/core:latest
    hostname: firefly
    depends_on:
    - db
    expose:
      - "8080"
    environment:
      # Application configuration
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=https://firefly.giocaizzi.xyz
      - SITE_OWNER=admin@firefly.home
      - DEFAULT_LANGUAGE=en_US
      - DEFAULT_LOCALE=equal
      
      # Timezone
      - TZ=Europe/Rome
      
      # Database configuration
      - DB_CONNECTION=mysql
      - DB_HOST=db
      - DB_PORT=3306
      - DB_DATABASE=firefly
      - DB_USERNAME=firefly
      
      # Security & Trust
      - TRUSTED_PROXIES=**
      - APP_LOG_LEVEL=notice
      - AUDIT_LOG_LEVEL=emergency
      
      # Mail configuration (optional)
      - MAIL_MAILER=log
      - MAIL_HOST=
      - MAIL_PORT=2525
      - MAIL_FROM=changeme@example.com
      - MAIL_USERNAME=
      - MAIL_PASSWORD=
      - MAIL_ENCRYPTION=
      
      # Authentication
      - LOGIN_PROVIDER=eloquent
      
      # Feature flags
      - DISABLE_FRAME_HEADER=false
      - DISABLE_CSP_HEADER=false
    secrets:
      - app_key
      - db_password
      - static_cron_token
    entrypoint:
      - /bin/sh
      - -c
      - |
        # Read secrets and set environment variables
        export APP_KEY=$$(cat /run/secrets/app_key)
        export DB_PASSWORD=$$(cat /run/secrets/db_password)
        export STATIC_CRON_TOKEN=$$(cat /run/secrets/static_cron_token)
        # Execute original entrypoint
        exec docker-php-serversideup-entrypoint /init
    volumes:
      - firefly_upload:/var/www/html/storage/upload
    networks:
      - firefly_network
      - public_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/about"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "firefly"
      com.giocaizzi.component: "app"
      com.giocaizzi.role: "backend"
      com.giocaizzi.tier: "core"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 512M
    logging:
      <<: *logging-base

  db:
    image: mariadb:lts
    hostname: db
    environment:
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/db_password
      - MYSQL_DATABASE=firefly
      - MYSQL_USER=firefly
      - MYSQL_PASSWORD_FILE=/run/secrets/db_password
      - MARIADB_AUTO_UPGRADE=1
      - MARIADB_DISABLE_UPGRADE_BACKUP=1
    secrets:
      - db_password
    volumes:
      - firefly_db:/var/lib/mysql
    configs:
      - source: mariadb_config
        target: /etc/mysql/conf.d/custom.cnf
        mode: 0444
    networks:
      - firefly_network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 20s
      timeout: 10s
      retries: 6
      start_period: 90s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "firefly-db"
      com.giocaizzi.component: "data"
      com.giocaizzi.role: "database"
      com.giocaizzi.tier: "core"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 384M
    logging:
      <<: *logging-base

  importer:
    image: fireflyiii/data-importer:latest
    hostname: firefly-importer
    depends_on:
      - firefly
    expose:
      - "8080"
    environment:
      # Firefly III connection
      - FIREFLY_III_URL=http://firefly:8080
      - VANITY_URL=https://firefly.giocaizzi.xyz
      
      # Timezone and Locale
      - TZ=Europe/Rome
      - FALLBACK_LOCALE=en_US
      
      # Security
      - TRUSTED_PROXIES=**
      - EXPECT_SECURE_URL=false
      - VERIFY_TLS_SECURITY=false
      
      # Logging
      - LOG_LEVEL=info
      
      # Performance
      - USE_CACHE=true
      
      # Auto-import configuration
      - IMPORT_DIR_ALLOWLIST=/var/www/html/import
      - CAN_POST_AUTOIMPORT=true
      - CAN_POST_FILES=true
      - IGNORE_DUPLICATE_ERRORS=false
    secrets:
      - firefly_client_id
      - lunch_flow_api_key
      - auto_import_secret
      - import_config
    entrypoint:
      - /bin/sh
      - -c
      - |
        # Read secrets and set environment variables
        export FIREFLY_III_CLIENT_ID=$$(cat /run/secrets/firefly_client_id)
        export LUNCH_FLOW_API_KEY=$$(cat /run/secrets/lunch_flow_api_key)
        export AUTO_IMPORT_SECRET=$$(cat /run/secrets/auto_import_secret)
        # Copy import config from secret to expected location
        mkdir -p /var/www/html/import
        cp /run/secrets/import_config /var/www/html/import/config.json
        # Execute original entrypoint
        exec docker-php-serversideup-entrypoint /init
    volumes:
      - firefly_upload:/var/www/html/storage/upload
    networks:
      - firefly_network
      - public_network
    healthcheck:
      test: ["CMD", "php", "-r", "echo file_get_contents('http://localhost:8080/health');"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "firefly-importer"
      com.giocaizzi.component: "worker"
      com.giocaizzi.role: "importer"
      com.giocaizzi.tier: "extra"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 256M
    logging:
      <<: *logging-base

  cron:
    image: alpine
    hostname: cron
    depends_on:
      - firefly
      - importer
    environment:
      - TZ=Europe/Rome
    secrets:
      - auto_import_secret
      - firefly_access_token
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c "apk add --no-cache tzdata wget docker-cli &&
      ln -sf /usr/share/zoneinfo/Europe/Rome /etc/localtime &&
      echo 'Waiting for Firefly to be ready...' &&
      until wget -q --spider http://firefly:8080/api/v1/about; do echo 'Waiting...'; sleep 30; done &&
      echo 'Firefly is ready, setting up cron jobs...' &&
      AUTO_IMPORT_SECRET=\$$(cat /run/secrets/auto_import_secret) &&
      FIREFLY_ACCESS_TOKEN=\$$(cat /run/secrets/firefly_access_token) &&
      echo '0 6 * * * docker exec \$$(docker ps --filter \"label=com.docker.swarm.service.name=firefly_firefly\" --format \"{{.Names}}\") php artisan firefly-iii:cron' > /tmp/crontab &&
      echo '0 6 * * * wget -qO- --post-data=\"\" --header=\"Accept: application/json\" --header=\"Authorization: Bearer '$$FIREFLY_ACCESS_TOKEN'\" http://firefly-importer:8080/autoimport?directory=/var/www/html/import\\&secret='$$AUTO_IMPORT_SECRET >> /tmp/crontab &&
      crontab /tmp/crontab &&
      rm /tmp/crontab &&
      echo 'Cron jobs configured:' &&
      crontab -l &&
      crond -f -L /dev/stdout"
    networks:
      - firefly_network
    labels:
      <<: *labels-base
      com.giocaizzi.service: "firefly-cron"
      com.giocaizzi.component: "worker"
      com.giocaizzi.role: "scheduler"
      com.giocaizzi.tier: "extra"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 64M
    logging:
      <<: *logging-base

  pico:
    image: cioraneanu/firefly-pico:latest
    hostname: firefly-pico
    depends_on:
      - pico-db
      - firefly
    expose:
      - "80"
    environment:
      - FIREFLY_URL=http://firefly:8080
      - DB_CONNECTION=pgsql
      - DB_HOST=pico-db
      - DB_PORT=5432
      - DB_DATABASE=firefly-pico
      - DB_USERNAME=firefly-pico
      - TZ=Europe/Rome
    secrets:
      - pico_db_password
    entrypoint:
      - /bin/sh
      - -c
      - |
        # Export DB password from Docker secret
        export DB_PASSWORD=$$(cat /run/secrets/pico_db_password)
        # Run official entrypoint (waits for DB, runs migrations, caches config from env vars, starts supervisord)
        exec /docker-entrypoint.d/start.sh
    networks:
      - firefly_network
      - public_network
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "firefly-pico"
      com.giocaizzi.component: "app"
      com.giocaizzi.role: "frontend"
      com.giocaizzi.tier: "extra"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 256M
    logging:
      <<: *logging-base

  pico-db:
    image: postgres:16-alpine
    hostname: pico-db
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    environment:
      - POSTGRES_DB=firefly-pico
      - POSTGRES_USER=firefly-pico
      - POSTGRES_PASSWORD_FILE=/run/secrets/pico_db_password
    secrets:
      - pico_db_password
    volumes:
      - firefly_pico_db:/var/lib/postgresql/data
    configs:
      - source: postgres_config
        target: /etc/postgresql/postgresql.conf
        mode: 0444
    networks:
      - firefly_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U firefly-pico -d firefly-pico"]
      interval: 20s
      timeout: 10s
      retries: 6
      start_period: 60s
    labels:
      <<: *labels-base
      com.giocaizzi.service: "firefly-pico-db"
      com.giocaizzi.component: "data"
      com.giocaizzi.role: "database"
      com.giocaizzi.tier: "extra"
    <<: *security-base
    deploy:
      <<: *deploy-base
      resources:
        limits:
          memory: 128M
    logging:
      <<: *logging-base

volumes:
  firefly_upload:
    driver: local
  firefly_db:
    driver: local
  firefly_pico_db:
    driver: local

configs:
  mariadb_config:
    file: ./mariadb/mariadb.cnf
  postgres_config:
    file: ./postgres/postgresql.conf

secrets:
  app_key:
    external: true
    name: firefly_app_key
  db_password:
    external: true
    name: firefly_db_password
  static_cron_token:
    external: true
    name: firefly_static_cron_token
  firefly_client_id:
    external: true
    name: firefly_client_id
  auto_import_secret:
    external: true
    name: firefly_auto_import_secret
  firefly_access_token:
    external: true
    name: firefly_access_token
  lunch_flow_api_key:
    external: true
    name: firefly_lunch_flow_api_key
  import_config:
    external: true
    name: firefly_import_config
  pico_db_password:
    external: true
    name: firefly_pico_db_password