networks:
  # Private network for firefly stack
  firefly_network:
    driver: overlay
    name: rp5_firefly
  
  # External network to connect to nginx proxy
  public_network:
    external: true
    name: rp5_public

services:
  firefly:
    image: fireflyiii/core:latest
    hostname: firefly
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "8080"
    environment:
      # Application configuration
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: "${APP_KEY}"
      APP_URL: "https://${FIREFLY_HOST:-firefly.local}"
      SITE_OWNER: "${SITE_OWNER:-admin@firefly.local}"
      DEFAULT_LANGUAGE: "${DEFAULT_LANGUAGE:-en_US}"
      DEFAULT_LOCALE: "${DEFAULT_LOCALE:-equal}"
      
      # Timezone
      TZ: "${TZ:-UTC}"
      
      # Database configuration
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: "${DB_DATABASE:-firefly}"
      DB_USERNAME: "${DB_USERNAME:-firefly}"
      DB_PASSWORD: "${DB_PASSWORD}"
      
      # Security & Trust
      TRUSTED_PROXIES: "**"
      APP_LOG_LEVEL: "${APP_LOG_LEVEL:-notice}"
      AUDIT_LOG_LEVEL: "${AUDIT_LOG_LEVEL:-emergency}"
      
      # Mail configuration (optional)
      MAIL_MAILER: "${MAIL_MAILER:-log}"
      MAIL_HOST: "${MAIL_HOST:-}"
      MAIL_PORT: "${MAIL_PORT:-2525}"
      MAIL_FROM: "${MAIL_FROM:-changeme@example.com}"
      MAIL_USERNAME: "${MAIL_USERNAME:-}"
      MAIL_PASSWORD: "${MAIL_PASSWORD:-}"
      MAIL_ENCRYPTION: "${MAIL_ENCRYPTION:-}"
      
      # Authentication
      LOGIN_PROVIDER: "${LOGIN_PROVIDER:-eloquent}"
      
      # Feature flags
      DISABLE_FRAME_HEADER: "${DISABLE_FRAME_HEADER:-false}"
      DISABLE_CSP_HEADER: "${DISABLE_CSP_HEADER:-false}"
    volumes:
      - firefly_upload:/var/www/html/storage/upload
    networks:
      - firefly_network
      - public_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/about"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "stack=firefly"
    security_opt:
      - no-new-privileges:true
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.5"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  db:
    image: mariadb:lts
    hostname: db
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
      MYSQL_DATABASE: "${DB_DATABASE:-firefly}"
      MYSQL_USER: "${DB_USERNAME:-firefly}"
      MYSQL_PASSWORD: "${DB_PASSWORD}"
      MARIADB_AUTO_UPGRADE: "1"
      MARIADB_DISABLE_UPGRADE_BACKUP: "1"
    volumes:
      - firefly_db:/var/lib/mysql
    networks:
      - firefly_network
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 20s
      timeout: 10s
      retries: 6
      start_period: 90s
    labels:
      - "stack=firefly"
    security_opt:
      - no-new-privileges:true
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  importer:
    # develop supports Lunch Flow integration (TODO: switch to stable when released)
    image: fireflyiii/data-importer:develop
    hostname: firefly-importer
    depends_on:
      firefly:
        condition: service_started
    expose:
      - "8080"
    environment:
      # Firefly III connection
      FIREFLY_III_URL: "http://firefly:8080"
      VANITY_URL: "https://${FIREFLY_HOST:-firefly.local}"
      FIREFLY_III_CLIENT_ID: "${FIREFLY_CLIENT_ID}"

      # Lunch flow
      LUNCH_FLOW_API_KEY: "${LUNCH_FLOW_API_KEY:-}"
      
      # Timezone and Locale
      TZ: "${TZ:-UTC}"
      FALLBACK_LOCALE: "${FALLBACK_LOCALE:-en_US}"
      
      # Security
      TRUSTED_PROXIES: "**"
      EXPECT_SECURE_URL: "false"
      VERIFY_TLS_SECURITY: "false"
      
      # Logging
      LOG_LEVEL: "${IMPORTER_LOG_LEVEL:-info}"
      
      # Performance
      USE_CACHE: "true"
      
      # Auto-import configuration
      IMPORT_DIR_ALLOWLIST: "/import"
      AUTO_IMPORT_SECRET: "${AUTO_IMPORT_SECRET}"
      CAN_POST_AUTOIMPORT: "true"
      CAN_POST_FILES: "true"
      IGNORE_DUPLICATE_ERRORS: "${IGNORE_DUPLICATE_ERRORS:-false}"
    volumes:
      - firefly_upload:/var/www/html/storage/upload
    networks:
      - firefly_network
      - public_network
    healthcheck:
      test: ["CMD", "php", "-r", "echo file_get_contents('http://localhost:8080/health');"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "stack=firefly"
    security_opt:
      - no-new-privileges:true
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.25"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cron:
    image: alpine
    hostname: cron
    depends_on:
      firefly:
        condition: service_started
      importer:
        condition: service_started
    environment:
      TZ: "${TZ:-UTC}"
      AUTO_IMPORT_SECRET: "${AUTO_IMPORT_SECRET}"
      FIREFLY_ACCESS_TOKEN: "${FIREFLY_III_ACCESS_TOKEN}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c "apk add --no-cache tzdata wget docker-cli &&
      ln -sf /usr/share/zoneinfo/$$TZ /etc/localtime &&
      echo 'Waiting for Firefly to be ready...' &&
      until wget -q --spider http://firefly:8080/api/v1/about; do echo 'Waiting...'; sleep 30; done &&
      echo 'Firefly is ready, setting up cron jobs...' &&
      echo '0 3 * * * docker exec \$$(docker ps --filter \"label=com.docker.swarm.service.name=firefly_firefly\" --format \"{{.Names}}\") php artisan firefly-iii:cron' > /tmp/crontab &&
      echo '40 2 * * * wget -qO- --post-data=\"\" --header=\"Accept: application/json\" --header=\"Authorization: Bearer '$$FIREFLY_ACCESS_TOKEN'\" http://firefly-importer:8080/autoimport?directory=/import\\&secret='$$AUTO_IMPORT_SECRET >> /tmp/crontab &&
      crontab /tmp/crontab &&
      rm /tmp/crontab &&
      echo 'Cron jobs configured:' &&
      crontab -l &&
      crond -f -L /dev/stdout"
    networks:
      - firefly_network
    labels:
      - "stack=firefly"
    security_opt:
      - no-new-privileges:true
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 64M
          cpus: "0.25"
        reservations:
          memory: 32M
          cpus: "0.1"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  firefly_upload:
    driver: local
  firefly_db:
    driver: local