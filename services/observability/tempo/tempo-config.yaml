# =============================================================================
# Tempo Configuration
# =============================================================================
# Distributed tracing backend. Receives traces ONLY from Alloy (OTLP).
# All trace ingestion flows through Alloy for consistent processing.
#
# Trace Flow:
#   Applications → Alloy (OTLP 4317/4318) → Tempo (OTLP 4317)
#
# Do NOT send traces directly to Tempo - use Alloy endpoint instead.
# =============================================================================

server:
  http_listen_port: 3200
  log_level: info

# Receive traces from Alloy only (internal network)
distributor:
  receivers:
    otlp:
      protocols:
        # Disable HTTP receiver to enforce gRPC-only ingestion
        # via Alloy.
        # http:
        #   endpoint: 0.0.0.0:4318
        grpc:
          endpoint: 0.0.0.0:4317

storage:
  trace:
    backend: local
    local:
      path: /var/tempo/traces
    wal:
      path: /var/tempo/wal
    pool:
      max_workers: 10
      queue_depth: 1000

compactor:
  compaction:
    block_retention: 720h # 30 days

# Metrics generator for TraceQL metrics queries (rate(), histogram)
# Required for queries using aggregations over traces.
# Generates metrics from spans and stores them in Prometheus.
metrics_generator:
  registry:
    external_labels:
      source: tempo
  storage:
    path: /var/tempo/generator/wal
    remote_write:
      - url: http://observability-metrics-store:9090/api/v1/write
        send_exemplars: true
  # Single-instance deployment - no ring configuration needed
  # The generator runs embedded in the Tempo monolith
  traces_storage:
    path: /var/tempo/generator/traces
  processor:
    # Enable local-blocks processor for TraceQL metrics
    # Required for rate(), count_over_time(), histogram_over_time()
    local_blocks:
      flush_to_storage: true
      max_block_duration: 1m
      max_block_bytes: 500000000
      complete_block_timeout: 1h
      filter_server_spans: true

overrides:
  defaults:
    metrics_generator:
      # Enable processors: service-graphs, span-metrics, local-blocks
      # local-blocks is required for TraceQL metrics queries
      processors: [service-graphs, span-metrics, local-blocks]
